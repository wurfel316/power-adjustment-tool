<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>電力調整用ツール</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 600px;
    margin: 40px auto;
  }
  input, button {
    padding: 8px;
    margin: 5px 0;
    width: 100%;
  }
  #result {
    margin-top: 15px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>電力調整用ツール</h2>

バッテリー出力：
<input id="a" type="number" step="10" value="1100">

不足電力：
<input id="t" type="number" step="5" value="0">

<button onclick="calc()">計算</button>

<div id="result"></div>

<script>
function calc() {

  const baseA = Number(document.getElementById("a").value);
  const A = baseA * 4; // 
  const T0 = Number(document.getElementById("t").value); // 元の目標
  const T = T0; // 計算用
  const minTarget = T0 + 5; // 安全ライン


  let current = 0;
  let value = A / 2;

  let used = [];

  const EPS = 1;

  let n = 1; // 1/2^n の n

  // できるだけ近づける
  while (value > EPS) {

    if (current + value <= T) {
      current += value;

      // 値と指数をセットで保存
      used.push({
        val: value,
        pow: n
      });
    }

    value /= 2;
    n++;
  }

// ===== +5以上になるよう補正 =====
if (current < minTarget) {

  // すでに使っている指数をSetに
  const usedPows = new Set(used.map(u => u.pow));

  let extraPow = n;
  let extraVal = A / Math.pow(2, extraPow);

  // 使ってない指数だけ探す
  while (
    extraPow > 0 &&
    (usedPows.has(extraPow) || current + extraVal < minTarget)
  ) {
    extraPow--;
    extraVal = A / Math.pow(2, extraPow);
  }

  // 見つかれば追加
  if (extraPow > 0 && !usedPows.has(extraPow)) {

    current += extraVal;

    used.push({
      val: extraVal,
      pow: extraPow
    });
  }
}

// 最後の項を「置き換える」方式
if (used.length > 0) {

  const last = used[used.length - 1];

  const newPow = last.pow - 1;
  const newVal = last.val * 2;

  // すでに使っていないか確認
  const exists = used.some(
    (u, i) => u.pow === newPow && i !== used.length - 1
  );

  if (!exists && newPow >= 1) {

    // ① last を削除
    used.pop();
    current -= last.val;

    // ② 2倍した項を追加
    current += newVal;

    used.push({
      val: newVal,
      pow: newPow
    });
  }
}

// ===== 2進表現を作る =====
const powSet = new Set(used.map(u => u.pow));

const maxPow = powSet.size > 0 ? Math.max(...powSet) : 0;

let bits = "";

for (let i = 1; i <= maxPow; i++) {
  bits += powSet.has(i) ? "1" : "0";
}

// ブロック表現を作る
let blocks = "";

for (const b of bits) {
  blocks += (b === "1") ? "■ " : "□ ";
}

  // 表示
if (used.length > 0) {
let text = "供給電力: " + current.toFixed(3) + "<br><br>";

text += "フラグ: " + bits + "<br>";
text += "ブロック表示: " + blocks + "<br><br>";


text += "使用した数:<br>";

  used.forEach(u => {
    text += `${u.val.toFixed(3)} （= ${baseA.toFixed(0)} × 4 × 1/2<sup>${u.pow}</sup>）<br>`;
  });

  document.getElementById("result").innerHTML = text;
 }
}
</script>
